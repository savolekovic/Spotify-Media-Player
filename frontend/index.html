<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Spotify Queue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes vz-bounce { 0%, 100% { transform: scaleY(0.35); } 50% { transform: scaleY(1); } }
        .now-playing.is-playing .bar { animation: vz-bounce 1.2s ease-in-out infinite; transform-origin: center bottom; }
        .now-playing.is-playing .bar:nth-child(2) { animation-delay: .15s; }
        .now-playing.is-playing .bar:nth-child(3) { animation-delay: .3s; }
        .now-playing.is-playing .bar:nth-child(4) { animation-delay: .45s; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-600 via-emerald-700 to-zinc-900 text-white antialiased">
    <div class="mx-auto w-full max-w-5xl px-4 py-8 md:py-12">
        <div class="rounded-2xl bg-zinc-900/70 ring-1 ring-white/10 shadow-2xl backdrop-blur">
            <div class="p-6 sm:p-8">
                <div class="auth-section text-center">
                    <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Office Spotify Queue</h1>
                    <p class="mt-3 text-sm text-zinc-300">Connect your Spotify account to manage the office music queue</p>
                    <button class="mt-6 inline-flex items-center rounded-full bg-emerald-600 px-5 py-3 text-sm font-semibold text-white shadow hover:bg-emerald-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300 focus-visible:ring-offset-2 focus-visible:ring-offset-zinc-900 transition" onclick="connectSpotify()">Connect to Spotify</button>
                </div>

                <div class="player-section hidden" id="playerSection">
                    <div class="mb-6 rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-4 text-center">
                        <p class="text-sm text-zinc-200"><strong class="text-emerald-400">Office Mode:</strong> Anyone can add songs to the queue and view what's playing. Use your phone or Spotify app to control playback.</p>
                    </div>

                    <div class="now-playing rounded-2xl bg-white/5 ring-1 ring-white/10 shadow-xl p-5 md:p-6">
                        <div class="track-info flex items-center gap-4 md:gap-6">
                            <img class="album-art h-20 w-20 md:h-24 md:w-24 rounded-lg object-cover shadow-lg" id="albumArt" src="" alt="Album art for current track">
                            <div class="track-details min-w-0">
                                <h3 id="trackName" class="truncate text-lg md:text-xl font-semibold">No track playing</h3>
                                <p id="artistName" class="truncate text-sm text-zinc-300">Connect your Spotify account</p>
                            </div>
                            <div class="ml-auto hidden sm:flex items-end gap-1" aria-hidden="true">
                                <span class="bar h-2 w-1 rounded-full bg-emerald-400"></span>
                                <span class="bar h-3 w-1 rounded-full bg-emerald-400"></span>
                                <span class="bar h-4 w-1 rounded-full bg-emerald-400"></span>
                                <span class="bar h-3 w-1 rounded-full bg-emerald-400"></span>
                            </div>
                        </div>

                        <div class="mt-5">
                            <div class="progress-bar h-1.5 w-full overflow-hidden rounded-full bg-white/10">
                                <div class="progress h-full bg-emerald-500 transition-all" id="progress" style="width: 0%"></div>
                            </div>
                            <div class="time-display mt-2 flex justify-between text-xs text-zinc-400">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>

                    <div class="queue-section mt-8">
                        <h2 class="text-lg font-semibold tracking-tight text-emerald-400">Add to Queue</h2>
                        <div class="search-section mt-3">
                            <label for="searchInput" class="sr-only">Search for songs, artists, or albums</label>
                            <input type="text" class="search-input w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder-zinc-400 outline-none focus:ring-2 focus:ring-emerald-500/60" placeholder="Search for songs, artists, or albums..." oninput="searchTracks(this.value)" id="searchInput" autocomplete="off" />
                        </div>
                        <div id="searchResults" class="search-results mt-3 max-h-80 overflow-y-auto divide-y divide-white/5">
                            <div class="status py-6 text-center text-sm text-zinc-400">Enter a search term to find tracks</div>
                        </div>

                        <h2 class="mt-8 text-lg font-semibold tracking-tight text-emerald-400">Current Queue</h2>
                        <div id="queueList" class="queue-list mt-3 max-h-96 overflow-y-auto divide-y divide-white/5">
                            <div class="status py-6 text-center text-sm text-zinc-400">Loading queue...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend API configuration - use same domain for production
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api/spotify'
            : '/api/spotify';
        
        let isAuthenticated = false;
        let isPlaying = false;
        let currentTrack = null;
        let playbackInterval = null;
        let lastQueueData = null;
        let queueUpdateCount = 0;

        // Initialize the app
        function init() {
            console.log('Initializing app...');
            
            // Check if we're returning from Spotify auth
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                console.log('Found authorization code, exchanging for token...');
                exchangeCodeForToken(code);
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                console.log('No authorization code found, checking authentication status...');
                // Force show auth section first, then check if already authenticated
                showAuthSection();
                checkAuthenticationStatus();
            }
        }

        async function getCurrentPlayback() {
            if (!isAuthenticated) return;

            try {
                const response = await fetch(`${API_BASE_URL}/current-playback`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.item) {
                        currentTrack = data.item;
                        updatePlayerDisplay(data.item, data.is_playing, data.progress_ms);
                    } else {
                        // No track playing
                        updatePlayerDisplay(null, false, 0);
                    }
                } else if (response.status === 401) {
                    // Token expired or invalid
                    isAuthenticated = false;
                    showAuthSection();
                }
            } catch (error) {
                console.error('Error getting current playback:', error);
            }
        }

        async function getQueue() {
            if (!isAuthenticated) return;

            try {
                const response = await fetch(`${API_BASE_URL}/queue`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Only update queue if it has actually changed
                    if (hasQueueChanged(data)) {
                        console.log('Queue updated:', data.queue_length, 'items');
                        displayQueue(data.queue || []);
                        lastQueueData = data;
                    }
                } else if (response.status === 401) {
                    // Token expired or invalid
                    isAuthenticated = false;
                    showAuthSection();
                }
            } catch (error) {
                console.error('Error getting queue:', error);
            }
        }

        // Check if queue has actually changed
        function hasQueueChanged(newData) {
            if (!lastQueueData) return true;
            
            // Compare queue lengths
            if (newData.queue_length !== lastQueueData.queue_length) {
                return true;
            }
            
            // Compare first few items to detect changes
            const newQueue = newData.queue || [];
            const oldQueue = lastQueueData.queue || [];
            
            if (newQueue.length !== oldQueue.length) {
                return true;
            }
            
            // Check if first item changed (most common case)
            if (newQueue.length > 0 && oldQueue.length > 0) {
                if (newQueue[0].uri !== oldQueue[0].uri) {
                    return true;
                }
            }
            
            return false;
        }

        async function checkAuthenticationStatus() {
            console.log('Checking authentication status...');
            try {
                const response = await fetch(`${API_BASE_URL}/current-playback`, {
                    credentials: 'include'
                });
                
                console.log('Auth check response status:', response.status);
                
                if (response.ok) {
                    console.log('User is authenticated, showing player section');
                    isAuthenticated = true;
                    showPlayerSection();
                    getCurrentPlayback();
                    getQueue();
                } else if (response.status === 401) {
                    // User not authenticated
                    console.log('User not authenticated (401), staying on auth section');
                } else {
                    console.log('Unexpected response status:', response.status);
                }
            } catch (error) {
                console.log('Error checking authentication:', error);
                console.log('User not authenticated (network error), staying on auth section');
            }
        }

        async function connectSpotify() {
            console.log('Connecting to Spotify...');
            try {
                const response = await fetch(`${API_BASE_URL}/auth-url`, {
                    credentials: 'include'
                });
                
                console.log('Auth URL response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Auth URL data:', data);
                    
                    if (data.authUrl) {
                        console.log('Redirecting to:', data.authUrl);
                        window.location.href = data.authUrl;
                    } else {
                        console.error('No auth URL received');
                        alert('Error: No auth URL received from server');
                    }
                } else {
                    console.error('Failed to get auth URL:', response.status, response.statusText);
                    alert('Error connecting to Spotify. Please try again.');
                }
            } catch (error) {
                console.error('Error getting auth URL:', error);
                alert('Error connecting to Spotify. Please try again.');
            }
        }

        async function exchangeCodeForToken(code) {
            console.log('Exchanging code for token...', code.substring(0, 10) + '...');
            try {
                const response = await fetch(`${API_BASE_URL}/exchange-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ code: code })
                });
                
                console.log('Token exchange response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Token exchange data:', data);
                    
                    if (data.success) {
                        console.log('Authentication successful');
                        isAuthenticated = true;
                        showPlayerSection();
                        getCurrentPlayback();
                        getQueue();
                    } else {
                        console.error('Authentication failed:', data);
                        alert('Authentication failed. Please try again.');
                    }
                } else {
                    console.error('Token exchange failed:', response.status, response.statusText);
                    alert('Authentication failed. Please try again.');
                }
            } catch (error) {
                console.error('Error exchanging token:', error);
                alert('Authentication failed. Please try again.');
            }
        }

        function showPlayerSection() {
            document.querySelector('.auth-section').style.display = 'none';
            document.querySelector('.player-section').style.display = 'block';
            
            // Start polling for current playback and queue
            if (playbackInterval) {
                clearInterval(playbackInterval);
            }
            playbackInterval = setInterval(() => {
                getCurrentPlayback();
                getQueue();
            }, 1000); // MODIFIED: Poll every 1s for more frequent updates
        }

        function showAuthSection() {
            document.querySelector('.auth-section').style.display = 'block';
            document.querySelector('.player-section').style.display = 'none';
            
            // Stop polling
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }

        function updatePlayerDisplay(track, playing, progressMs) {
            const nowPlayingEl = document.querySelector('.now-playing');
            if (nowPlayingEl) {
                nowPlayingEl.classList.toggle('is-playing', !!playing);
            }

            if (!track) {
                document.getElementById('trackName').textContent = 'No track playing';
                document.getElementById('artistName').textContent = 'Open Spotify and start playing music';
                document.getElementById('albumArt').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjQwIiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+4p2qPC90ZXh0Pgo8L3N2Zz4K';
                document.getElementById('progress').style.width = '0%';
                document.getElementById('currentTime').textContent = '0:00';
                document.getElementById('totalTime').textContent = '0:00';
                isPlaying = false;
                return;
            }

            // Escape HTML to prevent XSS
            const trackName = escapeHtml(track.name);
            const artistNames = track.artists?.map(a => escapeHtml(a.name)).join(', ') || 'Unknown Artist';
            
            document.getElementById('trackName').textContent = trackName;
            document.getElementById('artistName').textContent = artistNames;
            document.getElementById('albumArt').src = track.album?.images?.[0]?.url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjQwIiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+4p2qPC90ZXh0Pgo8L3N2Zz4K';
            
            const progress = track.duration_ms ? (progressMs / track.duration_ms) * 100 : 0;
            document.getElementById('progress').style.width = `${Math.min(progress, 100)}%`;
            
            document.getElementById('currentTime').textContent = formatTime(progressMs);
            document.getElementById('totalTime').textContent = formatTime(track.duration_ms);
            
            isPlaying = playing;
        }

        let searchTimeout;
        async function searchTracks(query) {
            if (!query.trim()) {
                document.getElementById('searchResults').innerHTML = '<div class="status py-6 text-center text-sm text-zinc-400">Enter a search term to find tracks</div>';
                return;
            }

            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (!isAuthenticated) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        displaySearchResults(data.tracks?.items || []);
                    } else {
                        document.getElementById('searchResults').innerHTML = '<div class="status py-6 text-center text-sm text-zinc-400">Error searching tracks</div>';
                    }
                } catch (error) {
                    console.error('Error searching tracks:', error);
                    document.getElementById('searchResults').innerHTML = '<div class="status py-6 text-center text-sm text-zinc-400">Error searching tracks</div>';
                }
            }, 300);
        }

        function displaySearchResults(tracks) {
            if (tracks.length === 0) {
                document.getElementById('searchResults').innerHTML = '<div class="status py-6 text-center text-sm text-zinc-400">No tracks found</div>';
                return;
            }

            const resultsHtml = tracks.map((track) => `
                <div class=\"track-item group flex items-center gap-3 p-3 sm:p-4\" data-track-uri=\"${escapeHtml(track.uri)}\">
                    <img class=\"h-10 w-10 sm:h-12 sm:w-12 rounded-md object-cover\" src=\"${track.album?.images?.[2]?.url || track.album?.images?.[0]?.url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjIwIiB5PSIyNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+4p2qPC90ZXh0Pgo8L3N2Zz4K'}\" alt=\"Album\">
                    <div class=\"track-item-info min-w-0\">
                        <h4 class=\"truncate text-sm font-medium\">${escapeHtml(track.name)}</h4>
                        <p class=\"truncate text-xs text-zinc-400\">${track.artists?.map(a => escapeHtml(a.name)).join(', ') || 'Unknown Artist'}</p>
                    </div>
                    <button class=\"add-btn ml-auto inline-flex items-center rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-emerald-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300\" onclick=\"addToQueue('${escapeHtml(track.uri)}', this)\">Add</button>
                </div>
            `).join('');

            document.getElementById('searchResults').innerHTML = resultsHtml;
        }

        function displayQueue(queue) {
            if (queue.length === 0) {
                document.getElementById('queueList').innerHTML = '<div class="status py-6 text-center text-sm text-zinc-400">Queue is empty</div>';
                return;
            }

            const displayQueueItems = queue.slice(0, 10);
            const remainingCount = queue.length - 10;

            const queueHtml = displayQueueItems.map((track, index) => `
                <div class=\"track-item group flex items-center gap-3 p-3 sm:p-4\">
                    <img class=\"h-10 w-10 sm:h-12 sm:w-12 rounded-md object-cover\" src=\"${track.album?.images?.[2]?.url || track.album?.images?.[0]?.url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjIwIiB5PSIyNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+4p2qPC90ZXh0Pgo8L3N2Zz4K'}\" alt=\"Album\">
                    <div class=\"track-item-info min-w-0\">
                        <h4 class=\"truncate text-sm font-medium\">${escapeHtml(track.name)}</h4>
                        <p class=\"truncate text-xs text-zinc-400\">${track.artists?.map(a => escapeHtml(a.name)).join(', ') || 'Unknown Artist'}</p>
                    </div>
                    <span class=\"ml-auto text-xs text-emerald-400\">#${index + 1}</span>
                </div>
            `).join('');

            let finalHtml = queueHtml;
            
            if (remainingCount > 0) {
                finalHtml += `<div class=\"status mt-2 text-center text-xs text-emerald-400\">+${remainingCount} more tracks in queue</div>`;
            }

            document.getElementById('queueList').innerHTML = finalHtml;
        }

        async function addToQueue(trackUri, buttonElement) {
            if (!isAuthenticated) return;

            try {
                const response = await fetch(`${API_BASE_URL}/add-to-queue`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ uri: trackUri })
                });
                
                if (response.ok) {
                    // Show success feedback
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'Added!';
                    buttonElement.classList.remove('bg-emerald-600');
                    buttonElement.classList.add('bg-emerald-500');
                    buttonElement.disabled = true;
                    
                    setTimeout(() => {
                        buttonElement.textContent = originalText;
                        buttonElement.classList.remove('bg-emerald-500');
                        buttonElement.classList.add('bg-emerald-600');
                        buttonElement.disabled = false;
                    }, 2000);
                    
                    // Refresh queue display
                    getQueue();
                } else {
                    console.error('Failed to add track to queue');
                }
            } catch (error) {
                console.error('Error adding to queue:', error);
            }
        }

        function formatTime(ms) {
            if (!ms) return '0:00';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize app when page loads
        init();
    </script>
</body>
</html>